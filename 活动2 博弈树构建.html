<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº•å­—æ£‹åšå¼ˆæ ‘æ„å»º - æ¢ç©¶æ´»åŠ¨</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f2f5;
        color: #333;
      }
      .header {
        text-align: center;
        padding: 20px;
        background-color: #1e3a8a;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
      }
      h1 {
        margin: 0;
        font-size: 2em;
        text-align: center;
      }
      .container {
        max-width: 1800px;
        margin: 20px auto;
        display: flex;
        gap: 20px;
        padding: 0 20px;
        box-sizing: border-box;
      }
      .palette-section,
      .workspace-section {
        min-width: 300px;
      }
      .palette-section {
        width: 320px;
      }
      .workspace-section {
        flex-grow: 1;
      }
      .section-title {
        text-align: center;
        color: #1e40af;
        margin-top: 0;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #dbeafe;
        border-radius: 6px;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .section-header .section-title {
        margin-bottom: 0;
        flex: 1;
      }
      .section-header .controls {
        margin-left: 15px;
        margin-bottom: 0;
      }
      button {
        padding: 10px 18px;
        font-size: 1em;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #2563eb;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
      }
      .palette {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding: 15px;
        background-color: #ffffff;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        height: calc(80vh + 80px);
        overflow-y: auto;
      }
      .palette-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      .node-label {
        font-weight: bold;
        color: #1e40af;
        font-size: 1.1em;
        margin-top: 5px;
      }
      .draggable-node {
        width: 120px;
        height: 120px;
        border: 2px solid #60a5fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #eff6ff;
        cursor: move;
        user-select: none;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        margin: 0 auto;
      }
      .ttt-board {
        width: 90px;
        height: 90px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 2px;
        background-color: #60a5fa;
        padding: 2px;
      }
      .cell {
        width: 28px;
        height: 28px;
        background-color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2em;
      }
      .cell.new-move-o {
        color: #3fe7f3;
        font-weight: 900;
        /* text-shadow: 0 0 3px rgba(63, 204, 243, 0.5); */
        /* transform: scale(1.1); */
      }
      .cell.new-move-x {
        color: #ef4444;
        font-weight: 900;
        /* text-shadow: 0 0 3px rgba(239, 68, 68, 0.5); */
        /* transform: scale(1.1); */
      }
      .delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background-color: #ef4444;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }
      .connection-point {
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        background-color: #94a3b8;
        border: 2px solid #64748b;
        border-radius: 50%;
        cursor: crosshair;
        z-index: 5;
        transition: all 0.2s ease;
      }
      .connection-point:hover {
        background-color: #3b82f6;
        border-color: #2563eb;
        transform: translateX(-50%) scale(1.3);
      }
      .workspace {
        min-height: 80vh;
        padding: 20px;
        background-color: #ffffff;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        position: relative;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .workspace-placeholder {
        text-align: center;
        color: #94a3b8;
        font-size: 1.2em;
        margin-top: 200px;
      }
      .status {
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
        color: #059669;
      }
      svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }
      line {
        stroke: #333;
        stroke-width: 2;
        marker-end: url(#arrowhead);
      }
      defs marker {
        fill: #333;
      }

      /* é—®é¢˜åŒºåŸŸæ ·å¼ */
      .questions-section {
        margin: 30px auto;
        max-width: 1800px;
        padding: 0 20px;
      }

      .questions-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
	  
	  .fill-in-blank-input {
		width: 40px;
		padding: 4px;
		border: 1px solid #ccc;
		text-align: center;
	  }

      .questions-title {
        text-align: center;
        margin-bottom: 25px;
        font-size: 1.8em;
        color: white;
        border-bottom: 3px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 15px;
      }

      .question-group {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .question-group h4 {
        color: #ffd700;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.3em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .question-group h4:before {
        content: "ğŸ”";
        font-size: 1.2em;
      }

      .question-group:nth-child(2) h4:before {
        content: "ğŸ¯";
      }

      .question-group:nth-child(3) h4:before {
        content: "ğŸ¤–";
      }

      .question-item {
        margin: 12px 0;
        padding-left: 20px;
        position: relative;
        line-height: 1.5;
      }

      .question-item:before {
        content: "â€¢";
        color: #ffd700;
        position: absolute;
        left: 0;
        font-size: 1.2em;
      }

      .thinking-hint {
        font-style: italic;
        color: #e0e0e0;
        font-size: 0.95em;
        margin-top: 8px;
        padding-left: 20px;
        border-left: 2px solid #ffd700;
        padding-top: 5px;
        padding-bottom: 5px;
      }

      .board-reference {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 4px;
        margin: 0 4px;
        font-weight: bold;
      }

      /* å›ç­”æ¡†æ ·å¼ */
      .answer-box {
        width: 100%;
        min-height: 80px;
        margin-top: 10px;
        padding: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-family: inherit;
        font-size: 1em;
        resize: vertical;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }

      .answer-box:focus {
        outline: none;
        border-color: #ffd700;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
      }

      .answer-box::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .answer-label {
        display: block;
        margin: 15px 0 8px 0;
        color: #ffd700;
        font-weight: bold;
      }

      /* éªŒè¯æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background-color: #ffffff;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e2e8f0;
      }

      .modal-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #1e40af;
      }

      .modal-close {
        font-size: 28px;
        font-weight: bold;
        color: #94a3b8;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
      }

      .modal-close:hover {
        color: #ef4444;
      }

      .validation-result {
        margin: 15px 0;
        padding: 15px;
        border-radius: 8px;
      }

      .validation-success {
        background-color: #d1fae5;
        border-left: 4px solid #10b981;
        color: #065f46;
      }

      .validation-error {
        background-color: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
      }

      .validation-warning {
        background-color: #fef3c7;
        border-left: 4px solid #f59e0b;
        color: #92400e;
      }

      .validation-item {
        margin: 8px 0;
        padding: 8px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 4px;
      }

      .validation-item.success {
        color: #059669;
      }

      .validation-item.error {
        color: #dc2626;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>æ´»åŠ¨2 åšå¼ˆæ ‘æ„å»º</h1>
    </div>

    <div class="container">
      <!-- å·¦ä¾§æ£‹ç›˜åº“éƒ¨åˆ† -->
      <div class="palette-section">
        <h2 class="section-title">æ£‹ç›˜åº“</h2>
        <div class="palette" id="nodePalette">
          <!-- æ£‹ç›˜A -->
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">A</div>
          </div>
          <!-- æ£‹ç›˜C -->
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">C</div>
          </div>
          <!-- æ£‹ç›˜D -->
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">D</div>
          </div>
          <!-- å…¶ä»–æ£‹ç›˜... -->
          <!-- æ£‹ç›˜B -->
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell"></div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">B</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">E</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">F</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell"></div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">G</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">K</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell"></div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">H</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">I</div>
          </div>
          <div class="palette-item">
            <div class="draggable-node" draggable="true">
              <div class="ttt-board">
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">X</div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">O</div>
                <div class="cell">X</div>
              </div>
            </div>
            <div class="node-label">J</div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§å·¥ä½œåŒºéƒ¨åˆ† -->
      <div class="workspace-section">
        <div class="section-header">
          <h2 class="section-title">åšå¼ˆæ ‘æ„å»ºåŒº</h2>
          <div class="controls">
            <button onclick="validateGameTree()">éªŒè¯åšå¼ˆæ ‘</button>
          </div>
        </div>
        <div class="workspace" id="workspace">
          <div class="workspace-placeholder">
            å°†æ£‹ç›˜ä»å·¦ä¾§æ‹–æ‹½åˆ°è¿™é‡Œå¼€å§‹æ„å»ºåšå¼ˆæ ‘...
          </div>
          <svg id="arrow-svg">
            <defs>
              <marker
                id="arrowhead"
                markerWidth="10"
                markerHeight="7"
                refX="10"
                refY="3.5"
                orient="auto"
                markerUnits="strokeWidth"
              >
                <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
              </marker>
            </defs>
          </svg>
        </div>
        <div class="status" id="statusMessage">
          å°±ç»ªã€‚æ‹–æ‹½èŠ‚ç‚¹ç§»åŠ¨ï¼Œç‚¹å‡»è¿æ¥ç‚¹ç»˜åˆ¶ç®­å¤´ï¼
        </div>
      </div>
    </div>

    <!-- ç­–ç•¥æ¢ç©¶é—®é¢˜åŒºåŸŸ -->
    <div class="questions-section">
      <div class="questions-container">
        <h2 class="questions-title">ğŸ¯ æ„å»ºå®Œæˆåšå¼ˆæ ‘åï¼Œæ€è€ƒä»¥ä¸‹é—®é¢˜</h2>

        <div class="question-group">
		  <h4>èƒœè´Ÿå¯èƒ½æ€§åˆ†æ</h4>
		  <div class="question-item">ä»åˆå§‹æ£‹ç›˜<span class="board-reference">A</span>å¼€å§‹ï¼š</div>
		  <div class="question-item">ï¼ˆ1ï¼‰å…ˆæ‰‹(O)èƒ½å¤Ÿè·èƒœçš„ç»“æœæœ‰ <input type="text" class="fill-in-blank-input" maxlength="2"> ç§ï¼Ÿ</div>
		  <div class="question-item">ï¼ˆ2ï¼‰åæ‰‹(X)èƒ½å¤Ÿè·èƒœçš„ç»“æœæœ‰ <input type="text" class="fill-in-blank-input" maxlength="2"> ç§ï¼Ÿ</div>
		  <div class="question-item">ï¼ˆ3ï¼‰å¹³å±€çš„ç»“æœæœ‰ <input type="text" class="fill-in-blank-input" maxlength="2"> ç§ï¼Ÿ</div>
		</div>

        <div class="question-group">
          <h4>æœ€ä¼˜ç­–ç•¥æ¨æ¼”</h4>
		  <div class="question-item">ä»åˆå§‹æ£‹ç›˜<span class="board-reference">A</span>å¼€å§‹ï¼š</div>
          <div class="question-item">ï¼ˆ1ï¼‰ å¦‚æœå…ˆæ‰‹(O)è¶³å¤Ÿèªæ˜ï¼Œæ€»èƒ½é€‰æ‹©æœ€ä½³èµ°æ³•ï¼Œæœ€ç»ˆä¼šæ˜¯ä»€ä¹ˆç»“å±€ï¼Ÿ <input type="text" class="fill-in-blank-input" maxlength="2"> </div>
          <div class="question-item">ï¼ˆ2ï¼‰ å¦‚æœåæ‰‹(X)ä¹Ÿè¶³å¤Ÿèªæ˜ï¼Œæ€»èƒ½æœ€ä¼˜åº”å¯¹ï¼Œç»“å±€ä¼šæ”¹å˜å—ï¼Ÿ <input type="text" class="fill-in-blank-input" maxlength="2"> </div>
          <div class="question-item">ï¼ˆ3ï¼‰ å¦‚æœä»æ£‹ç›˜<span class="board-reference">C</span>å¼€å§‹ï¼Œæœ€ä¼˜ç­–ç•¥ä¸‹çš„ç»“å±€æ˜¯ä»€ä¹ˆï¼Ÿ <input type="text" class="fill-in-blank-input" maxlength="2"> </div>
          <div class="question-item">ï¼ˆ4ï¼‰ å¦‚æœä»æ£‹ç›˜<span class="board-reference">D</span>å¼€å§‹ï¼Œç»“æœåˆä¼šå¦‚ä½•ï¼Ÿ <input type="text" class="fill-in-blank-input" maxlength="2"> </div>
        </div>

        <div class="question-group">
          <h4>AIè®¾è®¡æ€è€ƒ</h4>
          <div class="question-item">
            è¯·æ ¹æ®ä»¥ä¸Šé—®é¢˜æ€è€ƒï¼Œå¦‚æœè®©ä½ è®¾è®¡ä¸€ä¸ªAIæ¥ä¸‹æ£‹ï¼Œå®ƒä¼šå¦‚ä½•"æ€è€ƒ"å¹¶é€‰æ‹©ä¸‹ä¸€æ­¥ï¼Ÿ
          </div>
          <!-- <div class="question-item">- å®ƒä¼šå¦‚ä½•"æ€è€ƒ"å¹¶é€‰æ‹©ä¸‹ä¸€æ­¥ï¼Ÿ</div> -->
          <!-- <div class="question-item">- å®ƒéœ€è¦å‘å‰çœ‹å¤šå°‘æ­¥æ‰èƒ½ä¿è¯ä¸è¾“ï¼Ÿ</div> -->
          <!-- <div class="question-item">- é¢å¯¹ä¸åŒçš„æ£‹ç›˜å±€é¢ï¼Œå®ƒçš„å†³ç­–è¿‡ç¨‹ä¼šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</div> -->

          <span class="answer-label">ä½ çš„AIè®¾è®¡æ–¹æ¡ˆï¼š</span>
          <textarea
            class="answer-box"
            placeholder="è¯·åœ¨æ­¤æè¿°ä½ è®¾è®¡çš„AIæ€è€ƒè¿‡ç¨‹å’Œå†³ç­–é€»è¾‘..."
          ></textarea>

          <div class="thinking-hint">
            æç¤ºï¼šç»“åˆä½ åœ¨æ„å»ºåšå¼ˆæ ‘è¿‡ç¨‹ä¸­çš„ä½“éªŒï¼Œæƒ³è±¡AIçš„æ€è€ƒè¿‡ç¨‹
          </div>
        </div>
      </div>
    </div>

    <script>
      let isDragging = false;
      let draggedElement = null;
      let offsetX, offsetY;
      let isConnecting = false;
      let startNode = null;
      let connectionLine = null;
      const connectionLinesMap = new Map();
      window.connectionsArray = [];

      // æ‰€æœ‰æ£‹ç›˜çš„çŠ¶æ€å®šä¹‰
      const boardStates = {
        "A": ["O", "O", "X", "X", "", "", "", "O", "X"],
        "B": ["O", "O", "X", "X", "O", "", "", "O", "X"],
        "C": ["O", "O", "X", "X", "", "O", "", "O", "X"],
        "D": ["O", "O", "X", "X", "", "", "O", "O", "X"],
        "E": ["O", "O", "X", "X", "", "O", "X", "O", "X"],
        "F": ["O", "O", "X", "X", "X", "O", "", "O", "X"],
        "G": ["O", "O", "X", "X", "X", "", "O", "O", "X"],
        "H": ["O", "O", "X", "X", "", "X", "O", "O", "X"],
        "I": ["O", "O", "X", "X", "O", "O", "X", "O", "X"],
        "J": ["O", "O", "X", "X", "X", "O", "O", "O", "X"],
        "K": ["O", "O", "X", "X", "X", "O", "O", "O", "X"]
      };

      // å®šä¹‰æ¯ä¸ªæ£‹ç›˜çš„çˆ¶æ£‹ç›˜å…³ç³»
      const parentBoard = {
        "A": null,  // Aæ˜¯æ ¹èŠ‚ç‚¹ï¼Œæ²¡æœ‰çˆ¶èŠ‚ç‚¹
        "B": "A",
        "C": "A",
        "D": "A",
        "E": "C",
        "F": "C",
        "G": "D",
        "H": "D",
        "I": "E",
        "J": "F",
        "K": "G"
      };

      // éšæœºæ‰“ä¹±æ£‹ç›˜åº“ä¸­çš„æ£‹ç›˜é¡ºåº
      function shufflePalette() {
        const palette = document.getElementById("nodePalette");
        const items = Array.from(palette.querySelectorAll(".palette-item"));
        
        // Fisher-Yates æ´—ç‰Œç®—æ³•
        for (let i = items.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [items[i], items[j]] = [items[j], items[i]];
        }
        
        // é‡æ–°æ’åˆ—DOMå…ƒç´ 
        items.forEach((item) => {
          palette.appendChild(item);
        });
      }

      // æ ‡è®°æ–°ä¸‹çš„æ£‹å­
      function markNewMoves() {
        const palette = document.getElementById("nodePalette");
        const boards = palette.querySelectorAll(".ttt-board");
        
        boards.forEach((board) => {
          // è·å–æ£‹ç›˜æ ‡ç­¾
          const paletteItem = board.closest(".palette-item");
          const labelElement = paletteItem.querySelector(".node-label");
          const boardLabel = labelElement ? labelElement.textContent.trim() : null;
          
          if (!boardLabel || !boardStates[boardLabel]) return;
          
          const cells = board.querySelectorAll(".cell");
          const currentBoard = Array.from(cells).map(cell => cell.textContent.trim());
          
          // è·å–çˆ¶æ£‹ç›˜
          const parentLabel = parentBoard[boardLabel];
          if (!parentLabel || !boardStates[parentLabel]) {
            // å¦‚æœæ²¡æœ‰çˆ¶æ£‹ç›˜ï¼ˆå¦‚æ£‹ç›˜Aï¼‰ï¼Œä¸æ ‡è®°
            return;
          }
          
          const parentBoardState = boardStates[parentLabel];
          
          // æ‰¾å‡ºä¸çˆ¶æ£‹ç›˜ä¸åŒçš„ä½ç½®ï¼ˆæ–°ä¸‹çš„æ£‹å­ï¼‰
          // æ‰¾å‡ºæ‰€æœ‰ä¸åŒçš„ä½ç½®ï¼Œæ ‡è®°ç´¢å¼•æœ€å¤§çš„é‚£ä¸ªï¼ˆæœ€åä¸‹çš„æ£‹å­ï¼‰
          let lastNewMoveIndex = -1;
          for (let i = 0; i < 9; i++) {
            if (parentBoardState[i] !== currentBoard[i] && currentBoard[i] !== "") {
              // è®°å½•æ–°æ£‹å­çš„ä½ç½®
              lastNewMoveIndex = i;
            }
          }
          // æ ‡è®°æœ€åä¸‹çš„æ£‹å­ï¼ˆç´¢å¼•æœ€å¤§çš„é‚£ä¸ªï¼‰ï¼Œæ ¹æ®æ£‹å­ç±»å‹ä½¿ç”¨ä¸åŒé¢œè‰²
          if (lastNewMoveIndex >= 0) {
            const newMovePiece = currentBoard[lastNewMoveIndex];
            if (newMovePiece === "O") {
              cells[lastNewMoveIndex].classList.add("new-move-o");
            } else if (newMovePiece === "X") {
              cells[lastNewMoveIndex].classList.add("new-move-x");
            }
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const palette = document.getElementById("nodePalette");
        const workspace = document.getElementById("workspace");
        const arrowSvg = document.getElementById("arrow-svg");

        // éšæœºæ‰“ä¹±æ£‹ç›˜åº“ä¸­çš„æ£‹ç›˜é¡ºåº
        shufflePalette();

        // æ ‡è®°æ£‹ç›˜åº“ä¸­æ‰€æœ‰æ–°ä¸‹çš„æ£‹å­
        markNewMoves();

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ·»åŠ æ£‹ç›˜Aåˆ°å·¥ä½œåŒº
        initializeWorkspaceWithBoardA();

        function initializeWorkspaceWithBoardA() {
          // ç§»é™¤å ä½ç¬¦
          const placeholder = workspace.querySelector(".workspace-placeholder");
          if (placeholder) placeholder.remove();

          // åˆ›å»ºæ£‹ç›˜AèŠ‚ç‚¹
          const nodeA = document.createElement("div");
          nodeA.className = "draggable-node";
          nodeA.id = "node_initial_A";
          nodeA.style.position = "absolute";
          nodeA.style.left = "50%";
          nodeA.style.top = "20px";
          nodeA.style.transform = "translateX(-50%)";

          // æ·»åŠ æ£‹ç›˜å†…å®¹
          const board = document.createElement("div");
          board.className = "ttt-board";
          board.innerHTML = `
                    <div class="cell">O</div><div class="cell">O</div><div class="cell">X</div>
                    <div class="cell">X</div><div class="cell"></div><div class="cell"></div>
                    <div class="cell"></div><div class="cell">O</div><div class="cell">X</div>
                `;
          nodeA.appendChild(board);

          // æ·»åŠ æ ‡ç­¾
          const nodeLabel = document.createElement("div");
          nodeLabel.className = "node-label";
          nodeLabel.textContent = "A";
          nodeLabel.style.position = "absolute";
          nodeLabel.style.bottom = "-25px";
          nodeLabel.style.left = "50%";
          nodeLabel.style.transform = "translateX(-50%)";
          nodeLabel.style.fontWeight = "bold";
          nodeLabel.style.color = "#1e40af";
          nodeA.appendChild(nodeLabel);

          // æ·»åŠ è¿æ¥ç‚¹
          const connectionPoint = document.createElement("div");
          connectionPoint.className = "connection-point";
          nodeA.appendChild(connectionPoint);

          // æ·»åŠ åˆ é™¤æŒ‰é’®
          const deleteBtn = document.createElement("div");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Ã—";
          deleteBtn.onclick = function (event) {
            event.stopPropagation();
            // åˆå§‹èŠ‚ç‚¹ä¸å…è®¸åˆ é™¤
            document.getElementById("statusMessage").textContent =
              "åˆå§‹èŠ‚ç‚¹ä¸èƒ½åˆ é™¤ï¼";
          };
          nodeA.appendChild(deleteBtn);

          // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
          connectionPoint.addEventListener(
            "mousedown",
            handleConnectionPointMouseDown
          );
          nodeA.addEventListener("mousedown", handleNodeMouseDown);

          // å°†èŠ‚ç‚¹æ·»åŠ åˆ°å·¥ä½œåŒº
          workspace.appendChild(nodeA);

          // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
          document.getElementById("statusMessage").textContent =
            "åˆå§‹æ£‹ç›˜Aå·²åŠ è½½ï¼è¯·å¼€å§‹æ„å»ºåšå¼ˆæ ‘ã€‚";
        }

        function setupDraggableNodes() {
          const nodes = palette.querySelectorAll(".draggable-node");
          nodes.forEach((node) => {
            node.addEventListener("dragstart", function (e) {
              const label =
                this.closest(".palette-item").querySelector(
                  ".node-label"
                ).textContent;
              e.dataTransfer.setData("text/html", e.target.outerHTML);
              e.dataTransfer.setData("text/plain", label);
              e.dataTransfer.effectAllowed = "copy";
            });
          });
        }
        setupDraggableNodes();

        workspace.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "copy";
        });

        workspace.addEventListener("drop", function (e) {
          e.preventDefault();
          const html = e.dataTransfer.getData("text/html");
          const label = e.dataTransfer.getData("text/plain");

          if (html) {
            const placeholder = workspace.querySelector(
              ".workspace-placeholder"
            );
            if (placeholder) placeholder.remove();

            const newNode = document.createElement("div");
            newNode.innerHTML = html;
            const nodeElement = newNode.firstChild;

            nodeElement.id =
              "node_" + Date.now() + Math.random().toString(36).substring(2, 7);

            nodeElement.style.position = "absolute";
            nodeElement.style.left =
              e.clientX - workspace.getBoundingClientRect().left - 60 + "px";
            nodeElement.style.top =
              e.clientY - workspace.getBoundingClientRect().top - 60 + "px";
            nodeElement.removeAttribute("draggable");

            const nodeLabel = document.createElement("div");
            nodeLabel.className = "node-label";
            nodeLabel.textContent = label;
            nodeLabel.style.position = "absolute";
            nodeLabel.style.bottom = "-25px";
            nodeLabel.style.left = "50%";
            nodeLabel.style.transform = "translateX(-50%)";
            nodeLabel.style.fontWeight = "bold";
            nodeLabel.style.color = "#1e40af";
            nodeElement.appendChild(nodeLabel);

            const connectionPoint = document.createElement("div");
            connectionPoint.className = "connection-point";
            nodeElement.appendChild(connectionPoint);

            const deleteBtn = document.createElement("div");
            deleteBtn.className = "delete-btn";
            deleteBtn.textContent = "Ã—";
            deleteBtn.onclick = function (event) {
              event.stopPropagation();
              // æ£€æŸ¥æ˜¯å¦æ˜¯åˆå§‹èŠ‚ç‚¹A
              if (nodeElement.id === "node_initial_A") {
                document.getElementById("statusMessage").textContent =
                  "åˆå§‹èŠ‚ç‚¹ä¸èƒ½åˆ é™¤ï¼";
                return;
              }
              
              // è®¡ç®—å®é™…èŠ‚ç‚¹æ•°é‡ï¼ˆæ’é™¤svgå’Œplaceholderï¼‰
              const nodes = workspace.querySelectorAll(".draggable-node");
              if (nodes.length <= 1) {
                // å¦‚æœåªå‰©ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåˆå§‹èŠ‚ç‚¹Aï¼‰ï¼Œæ¸…ç©ºå¹¶é‡æ–°åˆå§‹åŒ–
                workspace.innerHTML =
                  '<div class="workspace-placeholder">å°†èŠ‚ç‚¹ä»å·¦ä¾§æ‹–æ‹½åˆ°è¿™é‡Œå¼€å§‹æ„å»ºä½ çš„åšå¼ˆæ ‘...</div>';
                const newSvg = document.createElement("svg");
                newSvg.id = "arrow-svg";
                newSvg.innerHTML =
                  '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="strokeWidth"><polygon points="0 0, 10 3.5, 0 7" fill="#333" /></marker></defs>';
                workspace.appendChild(newSvg);
                connectionLinesMap.clear();
                window.connectionsArray = [];
                // é‡æ–°åˆå§‹åŒ–åˆå§‹èŠ‚ç‚¹A
                initializeWorkspaceWithBoardA();
              } else {
                removeNodeConnections(nodeElement);
                nodeElement.remove();
              }
              document.getElementById("statusMessage").textContent =
                "èŠ‚ç‚¹å·²åˆ é™¤ã€‚";
            };
            nodeElement.appendChild(deleteBtn);

            connectionPoint.addEventListener(
              "mousedown",
              handleConnectionPointMouseDown
            );
            nodeElement.addEventListener("mousedown", handleNodeMouseDown);

            workspace.appendChild(nodeElement);
            
            // ç¡®ä¿æ–°æ·»åŠ çš„èŠ‚ç‚¹ä¹Ÿæ ‡è®°äº†æ–°æ£‹å­
            const newBoard = nodeElement.querySelector(".ttt-board");
            if (newBoard) {
              // è·å–æ£‹ç›˜æ ‡ç­¾
              const boardLabel = label;
              
              if (boardLabel && boardStates[boardLabel]) {
                const cells = newBoard.querySelectorAll(".cell");
                const currentBoard = Array.from(cells).map(cell => cell.textContent.trim());
                
                // è·å–çˆ¶æ£‹ç›˜
                const parentLabel = parentBoard[boardLabel];
                if (parentLabel && boardStates[parentLabel]) {
                  const parentBoardState = boardStates[parentLabel];
                  
                  // æ‰¾å‡ºä¸çˆ¶æ£‹ç›˜ä¸åŒçš„ä½ç½®ï¼ˆæ–°ä¸‹çš„æ£‹å­ï¼‰
                  // æ‰¾å‡ºæ‰€æœ‰ä¸åŒçš„ä½ç½®ï¼Œæ ‡è®°ç´¢å¼•æœ€å¤§çš„é‚£ä¸ªï¼ˆæœ€åä¸‹çš„æ£‹å­ï¼‰
                  let lastNewMoveIndex = -1;
                  for (let i = 0; i < 9; i++) {
                    if (parentBoardState[i] !== currentBoard[i] && currentBoard[i] !== "") {
                      // è®°å½•æ–°æ£‹å­çš„ä½ç½®
                      lastNewMoveIndex = i;
                    }
                  }
                  // æ ‡è®°æœ€åä¸‹çš„æ£‹å­ï¼ˆç´¢å¼•æœ€å¤§çš„é‚£ä¸ªï¼‰ï¼Œæ ¹æ®æ£‹å­ç±»å‹ä½¿ç”¨ä¸åŒé¢œè‰²
                  if (lastNewMoveIndex >= 0) {
                    const newMovePiece = currentBoard[lastNewMoveIndex];
                    if (newMovePiece === "O") {
                      cells[lastNewMoveIndex].classList.add("new-move-o");
                    } else if (newMovePiece === "X") {
                      cells[lastNewMoveIndex].classList.add("new-move-x");
                    }
                  }
                }
              }
            }
            
            document.getElementById("statusMessage").textContent =
              "èŠ‚ç‚¹å·²æ·»åŠ ï¼å¯æ‹–åŠ¨è°ƒæ•´ä½ç½®æˆ–ç‚¹å‡»èŠ‚ç‚¹ä¸‹æ–¹è¿æ¥ç‚¹ç»˜åˆ¶ç®­å¤´ã€‚";
          }
        });

        function handleNodeMouseDown(e) {
          // å¦‚æœç‚¹å‡»çš„æ˜¯è¿æ¥ç‚¹ã€åˆ é™¤æŒ‰é’®æˆ–æ ‡ç­¾ï¼Œä¸è§¦å‘æ‹–æ‹½
          if (
            e.target.classList.contains("connection-point") ||
            e.target.classList.contains("delete-btn") ||
            e.target.classList.contains("node-label")
          ) {
            return;
          }

          // å…è®¸æ‹–æ‹½èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ç‚¹å‡»å•å…ƒæ ¼æ—¶ï¼‰
          if (e.currentTarget.classList.contains("draggable-node")) {
            e.preventDefault();
            isDragging = true;
            draggedElement = e.currentTarget;
            // æ¸…é™¤transformå±æ€§ï¼Œé¿å…ä½ç½®è®¡ç®—é”™è¯¯
            draggedElement.style.transform = "none";
            const rect = draggedElement.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            document.getElementById("statusMessage").textContent =
              "æ­£åœ¨æ‹–åŠ¨èŠ‚ç‚¹...";
          }
        }

        document.addEventListener("mousemove", function (e) {
          if (isDragging && draggedElement) {
            e.preventDefault();
            const workspaceRect = workspace.getBoundingClientRect();
            let newLeft = e.clientX - workspaceRect.left - offsetX;
            let newTop = e.clientY - workspaceRect.top - offsetY;

            const nodeWidth = draggedElement.offsetWidth;
            const nodeHeight = draggedElement.offsetHeight;
            newLeft = Math.max(
              0,
              Math.min(newLeft, workspaceRect.width - nodeWidth)
            );
            newTop = Math.max(
              0,
              Math.min(newTop, workspaceRect.height - nodeHeight)
            );

            // ç¡®ä¿transformå·²è¢«æ¸…é™¤
            draggedElement.style.transform = "none";
            draggedElement.style.left = newLeft + "px";
            draggedElement.style.top = newTop + "px";
          }
        });

        document.addEventListener("mouseup", function (e) {
          if (isDragging) {
            isDragging = false;
            if (draggedElement) {
              redrawConnections();
              document.getElementById("statusMessage").textContent =
                "èŠ‚ç‚¹ç§»åŠ¨å®Œæˆã€‚";
            }
            draggedElement = null;
          }
          if (isConnecting) {
            finishConnection(e);
          }
        });
        
        // å¤„ç†é¡µé¢å¤±å»ç„¦ç‚¹æˆ–çª—å£å…³é—­æ—¶æ¸…ç†è¿æ¥çŠ¶æ€
        window.addEventListener("beforeunload", function() {
          if (isConnecting && connectionLine) {
            const arrowSvg = document.getElementById("arrow-svg");
            if (arrowSvg && arrowSvg.contains(connectionLine)) {
              arrowSvg.removeChild(connectionLine);
            }
            document.removeEventListener("mousemove", updateConnectionLine);
          }
        });
        
        // å¤„ç†é¼ æ ‡ç¦»å¼€çª—å£æ—¶å–æ¶ˆè¿æ¥
        document.addEventListener("mouseleave", function() {
          if (isConnecting && connectionLine) {
            const arrowSvg = document.getElementById("arrow-svg");
            if (arrowSvg && arrowSvg.contains(connectionLine)) {
              arrowSvg.removeChild(connectionLine);
            }
            document.removeEventListener("mousemove", updateConnectionLine);
            isConnecting = false;
            startNode = null;
            connectionLine = null;
            document.getElementById("statusMessage").textContent =
              "è¿æ¥å·²å–æ¶ˆã€‚";
          }
        });

        function handleConnectionPointMouseDown(e) {
          e.stopPropagation();
          e.preventDefault();

          // å¦‚æœå·²ç»åœ¨è¿æ¥ä¸­ï¼Œå…ˆå–æ¶ˆä¹‹å‰çš„è¿æ¥
          if (isConnecting && connectionLine) {
            arrowSvg.removeChild(connectionLine);
            connectionLine = null;
            document.removeEventListener("mousemove", updateConnectionLine);
          }

          startNode = e.currentTarget.parentElement;
          isConnecting = true;
          document.getElementById("statusMessage").textContent =
            "ç‚¹å‡»å¹¶æ‹–åŠ¨è¿æ¥ç‚¹ä»¥åˆ›å»ºç®­å¤´...";

          const rect = startNode.getBoundingClientRect();
          const workspaceRect = workspace.getBoundingClientRect();

          const startX = rect.left + rect.width / 2 - workspaceRect.left;
          const startY = rect.top + rect.height + 2 - workspaceRect.top;

          connectionLine = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line"
          );
          connectionLine.setAttribute("x1", startX);
          connectionLine.setAttribute("y1", startY);
          connectionLine.setAttribute("x2", startX);
          connectionLine.setAttribute("y2", startY);
          connectionLine.setAttribute("stroke", "#333");
          connectionLine.setAttribute("stroke-width", "2");
          connectionLine.setAttribute("marker-end", "url(#arrowhead)");
          arrowSvg.appendChild(connectionLine);

          document.addEventListener("mousemove", updateConnectionLine);
        }

        // updateConnectionLine å·²ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ

        function finishConnection(e) {
          if (!isConnecting) return;

          if (connectionLine) {
            arrowSvg.removeChild(connectionLine);
            connectionLine = null;
          }

          const targetNode = document.elementFromPoint(e.clientX, e.clientY);
          const actualTargetNode = targetNode?.closest(".draggable-node");

          if (actualTargetNode && actualTargetNode !== startNode) {
            const rect = actualTargetNode.getBoundingClientRect();
            const relativeY = e.clientY - rect.top;
            if (relativeY <= rect.height / 2) {
              const exists = window.connectionsArray.some(
                (conn) =>
                  conn.from === startNode && conn.to === actualTargetNode
              );
              if (!exists) {
                const line = drawConnection(startNode, actualTargetNode);
                if (line) {
                  const key = `${startNode.id}->${actualTargetNode.id}`;
                  connectionLinesMap.set(key, line);
                  window.connectionsArray.push({
                    from: startNode,
                    to: actualTargetNode,
                  });
                }
                document.getElementById("statusMessage").textContent =
                  "ç®­å¤´å·²åˆ›å»ºï¼";
              } else {
                document.getElementById("statusMessage").textContent =
                  "è¯¥è¿æ¥å·²å­˜åœ¨ã€‚";
              }
            } else {
              document.getElementById("statusMessage").textContent =
                "è¯·å°†ç®­å¤´è¿æ¥åˆ°ç›®æ ‡èŠ‚ç‚¹çš„ä¸ŠåŠéƒ¨åˆ†ã€‚";
            }
          } else {
            document.getElementById("statusMessage").textContent =
              "è¿æ¥å·²å–æ¶ˆã€‚";
          }

          isConnecting = false;
          startNode = null;
          document.removeEventListener("mousemove", updateConnectionLine);
        }

        function drawConnection(fromNode, toNode) {
          if (!workspace.contains(fromNode) || !workspace.contains(toNode)) {
            return null;
          }
          const fromRect = fromNode.getBoundingClientRect();
          const toRect = toNode.getBoundingClientRect();
          const workspaceRect = workspace.getBoundingClientRect();

          const x1 = fromRect.left + fromRect.width / 2 - workspaceRect.left;
          const y1 = fromRect.top + fromRect.height + 2 - workspaceRect.top;

          const x2 = toRect.left + toRect.width / 2 - workspaceRect.left;
          const y2 = toRect.top - workspaceRect.top;

          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line"
          );
          line.setAttribute("x1", x1);
          line.setAttribute("y1", y1);
          line.setAttribute("x2", x2);
          line.setAttribute("y2", y2);
          line.setAttribute("stroke", "#333");
          line.setAttribute("stroke-width", "2");
          line.setAttribute("marker-end", "url(#arrowhead)");

          arrowSvg.appendChild(line);
          return line;
        }

        function redrawConnections() {
          // åªé€‰æ‹©lineå…ƒç´ ï¼Œæ’é™¤defsä¸­çš„marker
          const lines = arrowSvg.querySelectorAll('line');
          lines.forEach((line) => {
            if (arrowSvg.contains(line)) {
              arrowSvg.removeChild(line);
            }
          });
          connectionLinesMap.clear();

          window.connectionsArray.forEach((conn) => {
            if (workspace.contains(conn.from) && workspace.contains(conn.to)) {
              const line = drawConnection(conn.from, conn.to);
              if (line) {
                const key = `${conn.from.id}->${conn.to.id}`;
                connectionLinesMap.set(key, line);
              }
            }
          });
        }

        function removeNodeConnections(nodeToRemove) {
          const keysToRemove = [];
          connectionLinesMap.forEach((line, key) => {
            const [fromId, toId] = key.split("->");
            if (fromId === nodeToRemove.id || toId === nodeToRemove.id) {
              keysToRemove.push(key);
              if (arrowSvg.contains(line)) {
                arrowSvg.removeChild(line);
              }
            }
          });
          keysToRemove.forEach((key) => connectionLinesMap.delete(key));
          window.connectionsArray = window.connectionsArray.filter(
            (conn) => conn.from !== nodeToRemove && conn.to !== nodeToRemove
          );
        }
      });

      // å°† updateConnectionLine æå–åˆ°å…¨å±€ä½œç”¨åŸŸ
      function updateConnectionLine(e) {
        if (!isConnecting || !connectionLine) return;
        const workspace = document.getElementById("workspace");
        const workspaceRect = workspace.getBoundingClientRect();
        connectionLine.setAttribute("x2", e.clientX - workspaceRect.left);
        connectionLine.setAttribute("y2", e.clientY - workspaceRect.top);
      }

      // éªŒè¯åšå¼ˆæ ‘
      function validateGameTree() {
        const workspace = document.getElementById("workspace");
        const nodes = workspace.querySelectorAll(".draggable-node");
        
        // æ”¶é›†å·¥ä½œåŒºä¸­çš„æ‰€æœ‰èŠ‚ç‚¹åŠå…¶æ ‡ç­¾
        const workspaceNodes = new Map();
        nodes.forEach((node) => {
          const labelElement = node.querySelector(".node-label");
          if (labelElement) {
            const label = labelElement.textContent.trim();
            workspaceNodes.set(node.id, label);
          }
        });

        // æ”¶é›†æ‰€æœ‰è¿æ¥å…³ç³»
        const connections = [];
        window.connectionsArray.forEach((conn) => {
          const fromLabel = workspaceNodes.get(conn.from.id);
          const toLabel = workspaceNodes.get(conn.to.id);
          if (fromLabel && toLabel) {
            connections.push({ from: fromLabel, to: toLabel });
          }
        });

        // éªŒè¯ç»“æœ
        const errors = [];
        const warnings = [];

        // è·å–æ‰€æœ‰åº”è¯¥å­˜åœ¨çš„èŠ‚ç‚¹ï¼ˆparentBoardä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬Aï¼‰
        const allRequiredNodes = new Set(["A"]);
        Object.keys(parentBoard).forEach((node) => {
          allRequiredNodes.add(node);
        });

        // è·å–å·¥ä½œåŒºä¸­å®é™…å­˜åœ¨çš„èŠ‚ç‚¹æ ‡ç­¾
        const existingNodes = new Set(Array.from(workspaceNodes.values()));

        // 1. æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„èŠ‚ç‚¹æ˜¯å¦éƒ½å­˜åœ¨
        allRequiredNodes.forEach((requiredNode) => {
          if (!existingNodes.has(requiredNode)) {
            errors.push(`ç¼ºå°‘èŠ‚ç‚¹${requiredNode}`);
          }
        });

        // 2. æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹è¿æ¥æ˜¯å¦æ­£ç¡®
        const nodesWithConnections = new Set(); // è®°å½•å·²æœ‰è¿æ¥çš„èŠ‚ç‚¹ï¼Œé¿å…é‡å¤æ£€æŸ¥
        
        workspaceNodes.forEach((label, nodeId) => {
          if (label === "A") return; // Aæ˜¯æ ¹èŠ‚ç‚¹ï¼Œè·³è¿‡

          const expectedParent = parentBoard[label];
          if (!expectedParent) {
            warnings.push(`èŠ‚ç‚¹${label}æœªå®šä¹‰çˆ¶èŠ‚ç‚¹`);
            return;
          }

          // æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
          if (!existingNodes.has(expectedParent)) {
            errors.push(`èŠ‚ç‚¹${label}çš„çˆ¶èŠ‚ç‚¹${expectedParent}ç¼ºå¤±`);
            return;
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰ä»çˆ¶èŠ‚ç‚¹åˆ°å½“å‰èŠ‚ç‚¹çš„è¿æ¥
          const hasCorrectConnection = connections.some(
            (conn) => conn.from === expectedParent && conn.to === label
          );

          // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯çš„è¿æ¥ï¼ˆä»å…¶ä»–èŠ‚ç‚¹è¿æ¥åˆ°å½“å‰èŠ‚ç‚¹ï¼‰
          const wrongConnections = connections.filter(
            (conn) => conn.to === label && conn.from !== expectedParent
          );

          if (wrongConnections.length > 0) {
            // æœ‰é”™è¯¯çš„è¿æ¥
            wrongConnections.forEach((conn) => {
              errors.push(`èŠ‚ç‚¹${label}è¿æ¥é”™è¯¯ï¼šåº”ä¸º${expectedParent}â†’${label}`);
            });
            nodesWithConnections.add(label); // æ ‡è®°ä¸ºå·²æ£€æŸ¥
          } else if (!hasCorrectConnection) {
            // æ²¡æœ‰æ­£ç¡®çš„è¿æ¥
            errors.push(`èŠ‚ç‚¹${label}ç¼ºå°‘çˆ¶èŠ‚ç‚¹è¿æ¥`);
            nodesWithConnections.add(label); // æ ‡è®°ä¸ºå·²æ£€æŸ¥
          } else {
            // è¿æ¥æ­£ç¡®
            nodesWithConnections.add(label); // æ ‡è®°ä¸ºå·²æ£€æŸ¥
          }
        });

        // 3. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„è¿æ¥ï¼ˆæœªå®šä¹‰çš„è¿æ¥ï¼‰
        connections.forEach((conn) => {
          const expectedParent = parentBoard[conn.to];
          if (expectedParent && conn.from !== expectedParent) {
            // è¿™ä¸ªé”™è¯¯å·²ç»åœ¨ä¸Šé¢æ£€æŸ¥è¿‡äº†ï¼Œè·³è¿‡
            return;
          }
          if (!expectedParent && conn.to !== "A") {
            warnings.push(`èŠ‚ç‚¹${conn.to}è¿æ¥æœªå®šä¹‰`);
          }
        });

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        showValidationResult(errors, warnings);
      }

      // æ˜¾ç¤ºéªŒè¯ç»“æœ
      function showValidationResult(errors, warnings) {
        const modal = document.getElementById("validationModal");
        const resultDiv = document.getElementById("validationResult");
        
        let html = "";

        if (errors.length === 0 && warnings.length === 0) {
          // å®Œå…¨æ­£ç¡®
          html += `<div class="validation-result validation-success">`;
          html += `<strong>âœ“ éªŒè¯é€šè¿‡ï¼</strong><br>`;
          html += `åšå¼ˆæ ‘ç»“æ„å®Œæ•´ä¸”æ­£ç¡®ï¼Œæ‰€æœ‰èŠ‚ç‚¹å’Œè¿æ¥å…³ç³»éƒ½ç¬¦åˆè¦æ±‚ã€‚`;
          html += `</div>`;
        } else {
          // æœ‰é”™è¯¯æˆ–è­¦å‘Šï¼Œè¿›è¡Œæ±‡æ€»
          if (errors.length > 0) {
            // åˆ†ç±»æ±‡æ€»é”™è¯¯
            const missingNodes = [];
            const missingParents = [];
            const missingConnections = [];
            const wrongConnections = [];

            errors.forEach((error) => {
              if (error.startsWith("ç¼ºå°‘èŠ‚ç‚¹")) {
                missingNodes.push(error.replace("ç¼ºå°‘èŠ‚ç‚¹", ""));
              } else if (error.includes("çˆ¶èŠ‚ç‚¹") && error.includes("ç¼ºå¤±")) {
                missingParents.push(error);
              } else if (error.includes("ç¼ºå°‘çˆ¶èŠ‚ç‚¹è¿æ¥")) {
                missingConnections.push(error.replace("èŠ‚ç‚¹", "").replace("ç¼ºå°‘çˆ¶èŠ‚ç‚¹è¿æ¥", ""));
              } else if (error.includes("è¿æ¥é”™è¯¯")) {
                wrongConnections.push(error);
              }
            });

            html += `<div class="validation-result validation-error">`;
            html += `<strong>âœ— éªŒè¯å¤±è´¥ï¼Œå‘ç° ${errors.length} ä¸ªé”™è¯¯ï¼š</strong><br><br>`;

            if (missingNodes.length > 0) {
              html += `ç¼ºå°‘èŠ‚ç‚¹ï¼š${missingNodes.join("ã€")}<br>`;
            }
            if (missingParents.length > 0) {
              html += `çˆ¶èŠ‚ç‚¹ç¼ºå¤±ï¼š${missingParents.length}ä¸ª<br>`;
            }
            if (missingConnections.length > 0) {
              html += `ç¼ºå°‘è¿æ¥ï¼š${missingConnections.join("ã€")}<br>`;
            }
            if (wrongConnections.length > 0) {
              html += `è¿æ¥é”™è¯¯ï¼š${wrongConnections.length}ä¸ª<br>`;
            }

            html += `</div>`;
          }

          if (warnings.length > 0) {
            html += `<div class="validation-result validation-warning">`;
            html += `<strong>âš  å‘ç° ${warnings.length} ä¸ªè­¦å‘Š</strong>`;
            html += `</div>`;
          }
        }

        resultDiv.innerHTML = html;
        modal.style.display = "block";
      }

      // å…³é—­æ¨¡æ€æ¡†
      function closeValidationModal() {
        const modal = document.getElementById("validationModal");
        modal.style.display = "none";
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      window.onclick = function(event) {
        const modal = document.getElementById("validationModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      }
    </script>
    <!-- éªŒè¯ç»“æœæ¨¡æ€æ¡† -->
    <div id="validationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">åšå¼ˆæ ‘éªŒè¯ç»“æœ</div>
          <button class="modal-close" onclick="closeValidationModal()">&times;</button>
        </div>
        <div id="validationResult"></div>
      </div>
    </div>

  </body>
</html>
